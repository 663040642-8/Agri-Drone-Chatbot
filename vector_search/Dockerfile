# Stage 1: Build & Install Dependencies
FROM python:3.11-slim AS builder

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ Python ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á Cache ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà interactive
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

WORKDIR /install

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
COPY requirements.txt .

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
# üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ requirements.txt ‡πÑ‡∏°‡πà‡∏°‡∏µ sentence-transformers
RUN pip install --no-cache-dir -r requirements.txt

# =======================================================
# Stage 2: Production Image (Image ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Deploy)
# =======================================================
FROM python:3.11-slim

WORKDIR /app

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Dependencies ‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å Stage 1
COPY --from=builder /usr/local/lib/python3.11/site-packages/ /usr/local/lib/python3.11/site-packages/

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
COPY . .

EXPOSE 8000

# üí° ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Port ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô Start Command
ENV PORT=8000
CMD ["uvicorn", "vector_search:app", "--host", "0.0.0.0", "--port", "8000"]